# Prometheus Configuration
# Pulse HPC Cluster Observability Platform
# Phase 3: Observability Excellence

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: "pulse-demo"
    environment: "development"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
      timeout: 10s
      api_version: v2

# Rule files for alerting
rule_files:
  - /etc/prometheus/rules/*.yml

# Remote write to VictoriaMetrics for long-term storage
remote_write:
  - url: http://victoriametrics:8428/api/v1/write
    queue_config:
      max_samples_per_send: 10000
      capacity: 20000
      max_shards: 10
    write_relabel_configs:
      # Add source label for debugging
      - source_labels: []
        target_label: __source__
        replacement: prometheus

scrape_configs:
  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          service: "prometheus"

  # Node Simulator - exposes GPU and CPU metrics
  - job_name: "node-simulator"
    static_configs:
      - targets: ["node-simulator:8082"]
        labels:
          service: "node-simulator"
    metrics_path: /metrics
    scrape_interval: 5s  # More frequent for demo purposes

  # API Gateway metrics
  - job_name: "api-gateway"
    static_configs:
      - targets: ["api-gateway:8081"]
        labels:
          service: "api-gateway"
    metrics_path: /metrics
    scrape_interval: 15s

  # Job Scheduler - SLURM-compatible workload management
  - job_name: "job-scheduler"
    static_configs:
      - targets: ["job-scheduler:8083"]
        labels:
          service: "job-scheduler"
    metrics_path: /metrics
    scrape_interval: 5s  # Frequent for job state changes

  # Alertmanager metrics
  - job_name: "alertmanager"
    static_configs:
      - targets: ["alertmanager:9093"]
        labels:
          service: "alertmanager"
    metrics_path: /metrics
    scrape_interval: 15s

  # VictoriaMetrics metrics
  - job_name: "victoriametrics"
    static_configs:
      - targets: ["victoriametrics:8428"]
        labels:
          service: "victoriametrics"
    metrics_path: /metrics
    scrape_interval: 15s

  # OpenTelemetry Collector metrics
  - job_name: "otel-collector"
    static_configs:
      - targets: ["otel-collector:8888"]
        labels:
          service: "otel-collector"
    metrics_path: /metrics
    scrape_interval: 15s
